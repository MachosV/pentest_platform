from django.contrib.auth import authenticate, login
from django.shortcuts import redirect
from django.contrib import messages
from django.contrib.auth.models import User
from django.db.models import Q
from daedalus.models import PentesterProfile

def CreatePentester(request):
    if isinstance(request.user,PentesterProfile):
        return redirect('Dashboard')
    if request.user.is_anonymous():
        return redirect('Login')
    username = request.POST['username']
    password = request.POST['password']
    email = request.POST['email']
    user = User.objects.filter(Q(username=username) | Q(email=email))
    if user.exists():
        messages.info(request,'User or email already exists')
        return redirect('SignupTester')
    else:
        if request.user.managerprofile.remaining_users > 0:
            user = User(username = username, email = email)
            user.set_password(password)
            user.save()
            userprofile = PentesterProfile(user=user,manager = request.user.managerprofile)
            userprofile.save()
            request.user.managerprofile.remaining_users -= 1
            request.user.managerprofile.save()
            messages.info(request,'User successfully created')
        else:
            messages.error(request,'No remaining users left')
        return redirect('Dashboard')